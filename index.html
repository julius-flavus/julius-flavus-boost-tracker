```html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Julius Flavus — EVE Boost Tracker (Roster + Paste)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b0f14; color: #e7eef7; }
    header { padding: 16px 18px; border-bottom: 1px solid #1a2430; background: #0e141c; position: sticky; top: 0; z-index: 10;}
    h1 { margin: 0; font-size: 16px; letter-spacing: .3px; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 18px; display: grid; gap: 14px; }
    .row { display: grid; gap: 14px; grid-template-columns: 1.2fr .8fr; }
    @media (max-width: 980px){ .row { grid-template-columns: 1fr; } }
    .card { background: #0e141c; border: 1px solid #1a2430; border-radius: 14px; padding: 14px; box-shadow: 0 6px 20px rgba(0,0,0,.25); }
    .muted { color: #9db0c6; }
    label { font-size: 12px; color: #9db0c6; display:block; margin-bottom: 6px; }
    textarea { width: 100%; min-height: 240px; resize: vertical; border-radius: 10px; border: 1px solid #233043; padding: 10px; color: #e7eef7; background:#0b1118; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12.5px; line-height: 1.35; }
    button { border: 1px solid #233043; background:#111a24; color:#e7eef7; padding: 9px 10px; border-radius: 10px; cursor: pointer; }
    button:hover { background:#152233; }
    button:disabled { opacity:.55; cursor:not-allowed; }

    /* Destructive action */
    .dangerbtn { border-color: #6b2f2f; color: #ffc7c7; background: rgba(107,47,47,.18); }
    .dangerbtn:hover { background: rgba(107,47,47,.35); }

    .btnrow { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #1a2430; padding: 8px 6px; font-size: 13px; vertical-align: top; }
    th { text-align:left; color:#9db0c6; font-weight: 600; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #2a3a52; color:#cfe0f6; font-size: 12px; margin-right: 6px; margin-top: 4px; }
    .ok { border-color:#2f6b4f; color:#bff3d8; background: rgba(47,107,79,.12); }
    .warn { border-color:#7a5a2a; color:#ffe2b5; background: rgba(122,90,42,.12); }
    .dupe { border-color:#2b5bd7; color:#cfe0ff; background: rgba(43,91,215,.14); }
    .bad  { border-color:#6b2f2f; color:#ffc7c7; background: rgba(107,47,47,.12); }
    .neutral {border-color: #e7eef7;color: #e7eef7;background: rgba(231,238,247,.08);}
    .small { font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .hr { height: 1px; background:#1a2430; margin: 12px 0; }
    .right { text-align:right; }
    .copybox { width:100%; min-height: 110px; border-radius: 10px; border: 1px solid #233043; padding: 10px; color: #e7eef7; background:#0b1118; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12.5px; line-height: 1.35; white-space: pre-wrap; }
    .foot { color:#9db0c6; font-size: 12px; }
    .ghostbtn { background: transparent; border-color:#2a3a52; }
    .ghostbtn:hover { background:#101a25; }

    /* Mindlink toggle */
    .mlwrap { display:flex; align-items:center; gap:8px; }
    .mlwrap input[type="checkbox"]{ transform: translateY(1px); }

    /* profile chooser + warning */
    .profileCard { border-color:#314760; box-shadow: 0 10px 28px rgba(0,0,0,.28); }
    .profileTitle { display:flex; justify-content: space-between; align-items:center; gap:10px; }
    .profileTitle b { font-size: 13px; letter-spacing:.2px; }
    .profileChoices { display:flex; gap:10px; flex-wrap: wrap; margin-top:10px; }
    .choiceBtn {
      border: 1px solid #2a3a52;
      background:#0f1822;
      padding: 10px 12px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .choiceBtn .badge {
      width: 10px; height:10px; border-radius: 999px; border:1px solid #2a3a52;
      background: rgba(231,238,247,.10);
      display:inline-block;
    }
    .choiceBtn.active { border-color:#2f6b4f; background: rgba(47,107,79,.12); }
    .choiceBtn.active .badge { border-color:#2f6b4f; background:#bff3d8; }
    .profileWarn {
      margin-top:10px;
      border: 1px solid #7a5a2a;
      background: rgba(122,90,42,.10);
      color:#ffe2b5;
      border-radius: 12px;
      padding: 10px 12px;
      display:none;
    }
    .profileWarn strong { color:#ffe2b5; }

    /* category header rows in the wanted table */
    .catrow td{
      border-bottom: 1px solid #1a2430;
      padding: 10px 6px 6px;
      color:#9db0c6;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .8px;
      font-size: 11px;
      background: rgba(231,238,247,.04);
    }

    /* editable ship input */
    .shipEdit{
      width: 100%;
      max-width: 240px;
      border-radius: 10px;
      border: 1px solid #233043;
      padding: 6px 8px;
      color: #e7eef7;
      background:#0b1118;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12.5px;
      line-height: 1.2;
      outline: none;
    }
    .shipEdit:focus{
      border-color:#2a3a52;
      box-shadow: 0 0 0 3px rgba(43,91,215,.18);
    }

    /* paste clear blink animation */
    @keyframes pasteBlink {
      0%   { box-shadow: 0 0 0 0 rgba(43,91,215,.0);   filter:none; }
      25%  { box-shadow: 0 0 0 4px rgba(43,91,215,.22); filter:brightness(1.06); }
      50%  { box-shadow: 0 0 0 2px rgba(43,91,215,.0);  filter:none; }
      75%  { box-shadow: 0 0 0 4px rgba(43,91,215,.22); filter:brightness(1.06); }
      100% { box-shadow: 0 0 0 0 rgba(43,91,215,.0);   filter:none; }
    }
    .blinkClear { animation: pasteBlink 520ms ease-in-out 1; }
  </style>
</head>

<body>
<header>
  <h1>Julius Flavus’ EVE Boost Tracker</h1>
</header>

<div class="wrap">

  <div class="row">
    <div class="card">
      <label>Paste boost chat lines (you can paste repeatedly; roster persists)</label>
      <textarea id="chatInput" placeholder='Examples:
[18:21:20] Julius Flavus > <url=showinfo:42834>Armor Reinforcement Charge</url>  <url=showinfo:42833>Rapid Repair Charge</url> Damnation ML
[19:07:48] Tavitica > <url=showinfo:42837//1052088085006>Electronic Hardening Charge</url>  <url=showinfo:42836//1052088085003>Electronic Superiority Charge</url>'></textarea>

      <div class="btnrow" style="margin-top:10px;">
        <button id="applyBtn">Apply to roster</button>
        <button id="clearRosterBtn" class="dangerbtn">Clear roster</button>
        <span class="muted small" id="statusText"></span>
      </div>

      <div class="hr"></div>

      <div class="muted small">Current roster (remove people who leave/die; toggle ML if needed; edit ship if it guessed wrong)</div>
      <table>
        <thead>
          <tr>
            <th style="width: 30%;">Pilot</th>
            <th style="width: 18%;">Ship</th>
            <th style="width: 12%;">ML?</th>
            <th>Charges</th>
            <th style="width: 10%;">Action</th>
          </tr>
        </thead>
        <tbody id="rosterTable"></tbody>
      </table>
    </div>

    <!-- Profile selection (ONLY top buttons are used to load wanted charges) -->
    <div class="card profileCard">
      <div class="profileTitle">
        <div>
          <b>Pick your boosts profile</b>
          <div class="muted small">Armor / Shield / Mining — this fills the “Wanted charges” list.</div>
        </div>
        <span class="pill warn" id="profilePill">No profile selected</span>
      </div>

      <div class="profileChoices">
        <button id="profileArmorBtn" class="choiceBtn" type="button" aria-pressed="false">
          <span class="badge"></span><span><b>Armor</b> PvP</span>
        </button>
        <button id="profileShieldBtn" class="choiceBtn" type="button" aria-pressed="false">
          <span class="badge"></span><span><b>Shield</b> PvP</span>
        </button>
        <button id="profileMiningBtn" class="choiceBtn" type="button" aria-pressed="false">
          <span class="badge"></span><span><b>Mining</b></span>
        </button>
      </div>

      <div class="profileWarn" id="profileWarn">
        <strong>Heads up:</strong> You haven’t selected a profile yet.
        Pick <b>Armor</b>, <b>Shield</b>, or <b>Mining</b> so the tracker knows what charges you want.
      </div>

      <div class="hr"></div>

      <label>Wanted charges (one per line)</label>
      <textarea id="wantedInput" class="mono" style="min-height: 220px;"></textarea>

      <div class="btnrow" style="margin-top:10px;">
        <button id="clearWantedBtn" class="ghostbtn">Clear wanted</button>
      </div>

      <p class="foot" style="margin-top:10px;">
        Uses <b>exact charge names</b> from EVE command burst ammo lists.
      </p>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <div class="btnrow" style="justify-content: space-between;">
        <div>
          <div class="muted small">Filled vs missing (from roster)</div>
          <div id="summaryPills"></div>
        </div>
        <div class="right">
          <div class="muted small">Last update</div>
          <div id="lastUpdate" class="small mono">—</div>
        </div>
      </div>

      <div class="hr"></div>

      <table>
        <thead>
          <tr>
            <th style="width: 28%;">Wanted charge</th>
            <th style="width: 36%;">Filled by (ship + ML)</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="wantedTable"></tbody>
      </table>
    </div>

    <div class="card">
      <div class="muted small">Copy/paste back into EVE chat</div>
      <div class="hr"></div>

      <label>“Need these charges” message</label>
      <div class="copybox" id="needMsg"></div>
      <div class="btnrow" style="margin-top:8px;">
        <button data-copy="needMsg">Copy</button>
      </div>

      <div class="hr"></div>

      <label>“Filled charges (with who/ship/ML)” message</label>
      <div class="copybox" id="filledMsg"></div>
      <div class="btnrow" style="margin-top:8px;">
        <button data-copy="filledMsg">Copy</button>
      </div>

      <div class="hr"></div>

      <label>Duplicate charges (more than one pilot providing the same charge)</label>
      <div class="copybox" id="dupeMsg"></div>
      <div class="btnrow" style="margin-top:8px;">
        <button data-copy="dupeMsg">Copy</button>
      </div>
    </div>
  </div>

  <div class="card foot">
    <b>How it works:</b> You paste chat. We parse
    <code>&lt;url=showinfo:...&gt;Charge Name&lt;/url&gt;</code> links
    (including weird <code>//</code> variants and trailing <code>*</code>), update a
    <b>persistent roster</b>, then compare roster vs your “wanted” list.
    <div style="margin-top:10px; font-size:11px; opacity:.85;">
      © <span id="year"></span> Julius Flavus. All rights reserved.
    </div>
  </div>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
  </script>

</div>

<script>
const STORAGE_KEY = "eveBoostTracker_roster_v3_julius";

function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return { roster: {}, wantedText: "", selectedProfile: "" };
  try {
    const st = JSON.parse(raw);
    return {
      roster: st.roster || {},
      wantedText: typeof st.wantedText === "string" ? st.wantedText : "",
      selectedProfile: typeof st.selectedProfile === "string" ? st.selectedProfile : ""
    };
  } catch {
    localStorage.removeItem(STORAGE_KEY);
    return loadState();
  }
}
function saveState(state) { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

function armorPvpWanted() {
  return [
    "Armor Reinforcement Charge",
    "Armor Energizing Charge",
    "Rapid Repair Charge",
    "Electronic Hardening Charge",
    "Electronic Superiority Charge",
    "Sensor Optimization Charge",
    "Interdiction Maneuvers Charge",
    "Rapid Deployment Charge",
    "Evasive Maneuvers Charge"
  ];
}
function shieldPvpWanted() {
  return [
    "Shield Extension Charge",
    "Shield Harmonizing Charge",
    "Active Shielding Charge",
    "Electronic Hardening Charge",
    "Electronic Superiority Charge",
    "Sensor Optimization Charge",
    "Interdiction Maneuvers Charge",
    "Rapid Deployment Charge",
    "Evasive Maneuvers Charge"
  ];
}
function miningWanted() {
  return [
    "Mining Laser Optimization Charge",
    "Mining Equipment Preservation Charge",
    "Mining Laser Field Enhancement Charge"
  ];
}

const INFO_CHARGES = new Set([
  "Electronic Hardening Charge",
  "Electronic Superiority Charge",
  "Sensor Optimization Charge",
  "Recon Operation Charge",
  "Targeting Range Charge"
].map(s => s.toLowerCase()));

const SKIRMISH_CHARGES = new Set([
  "Interdiction Maneuvers Charge",
  "Rapid Deployment Charge",
  "Evasive Maneuvers Charge",
  "Interdiction Nullifier Charge"
].map(s => s.toLowerCase()));

const MINING_CHARGES = new Set([
  "Mining Laser Optimization Charge",
  "Mining Equipment Preservation Charge",
  "Mining Laser Field Enhancement Charge"
].map(s => s.toLowerCase()));

const ARMOR_CHARGES = new Set([
  "Armor Reinforcement Charge",
  "Armor Energizing Charge",
  "Rapid Repair Charge"
].map(s => s.toLowerCase()));

const SHIELD_CHARGES = new Set([
  "Shield Extension Charge",
  "Shield Harmonizing Charge",
  "Active Shielding Charge"
].map(s => s.toLowerCase()));

function chatTagForCharge(chargeName){
  const n = (chargeName || "").trim().toLowerCase();
  if (SHIELD_CHARGES.has(n)) return "[Shield]";
  if (ARMOR_CHARGES.has(n)) return "[Armor]";
  if (SKIRMISH_CHARGES.has(n)) return "[Skirm]";
  if (INFO_CHARGES.has(n)) return "[Info]";
  if (MINING_CHARGES.has(n)) return "[Mining]";
  return "[Other]";
}
function formatProviders(providers){
  const uniq = [...new Set(providers)].filter(Boolean);
  return uniq.join(", ");
}
function chargeCategory(chargeName){
  const n = (chargeName || "").trim().toLowerCase();
  if (SHIELD_CHARGES.has(n)) return "shield";
  if (ARMOR_CHARGES.has(n)) return "armor";
  if (SKIRMISH_CHARGES.has(n)) return "skirmish";
  if (INFO_CHARGES.has(n)) return "information";
  if (MINING_CHARGES.has(n)) return "mining";
  return "other";
}

const SHIPS_RAW = `Abaddon
Absolution
Adrestia
Aeon
Algos
Aliastra Catalyst
Alligator
Amarr Shuttle
Anathema
Anshar
Apocalypse
Apocalypse Imperial Issue
Apocalypse Navy Issue
Apostle
Apotheosis
Arazu
Arbitrator
Archon
Ares
Ark
Armageddon
Armageddon Imperial Issue
Armageddon Navy Issue
Ashimmu
Astarte
Astero
Atron
Augoror
Augoror Navy Issue
Avalanche
Avatar
Azariel
Badger
Bane
Bantam
Barghest
Basilisk
Bellicose
Bestla
Bestower
Bhaalgorn
Bifrost
Blackbird
Boobook
Bowhead
Breacher
Broadsword
Brutix
Brutix Navy Issue
Brutix Navy Issue
Burst
Bustard
Buzzard
Caedes
Caiman
Caldari Navy Hookbill
Caldari Shuttle
Cambion
Caracal
Caracal Navy Issue
Catalyst
Catalyst Navy Issue
Celestis
Cenotaph
Cerberus
Chameleon
Charon
Cheetah
Chemosh
Chimera
Chremoas
Civilian Amarr Shuttle
Civilian Caldari Shuttle
Civilian Gallente Shuttle
Civilian Minmatar Shuttle
Claw
Claymore
Cobra
Coercer
Coercer Navy Issue
Condor
Confessor
Corax
Cormorant
Cormorant Navy Issue
Council Diplomatic Shuttle
Covetor
Crane
Crow
Crucifier
Crucifier Navy Issue
Cruor
Crusader
Curse
Cybele
Cyclone
Cyclone Fleet Issue
Cynabal
Dagon
Damavik
Damnation
Daredevil
Deacon
Deimos
Deluge
Devoter
Dominix
Dominix Navy Issue
Dragoon
Drake
Drake Navy Issue
Dramiel
Draugur
Drekavac
Eagle
Echelon
Echo
Eidolon
Endurance
Enforcer
Enyo
Eos
Epithal
Erebus
Eris
Etana
Executioner
Exequror
Exequror Navy Issue
Falcon
Federation Navy Comet
Fenrir
Ferox
Ferox Navy Issue
Fiend
Flycatcher
Freki
Gallente Shuttle
Garmur
Geri
Gila
Gnosis
Gold Magnate
Golem
Goru's Shuttle
Griffin
Griffin Navy Issue
Guardian
Guardian-Vexor
Guristas Shuttle
Harbinger
Harbinger Navy Issue
Harpy
Hawk
Hecate
Hel
Helios
Hematos
Heretic
Heron
Heron Navy Issue
Hoarder
Hound
Hubris
Huginn
Hulk
Hurricane
Hurricane Fleet Issue
Hydra
Hyena
Hyperion
Ibis
Ikitursa
Imicus
Imicus Navy Issue
Immolator
Imp
Impairor
Impel
Imperial Navy Slicer
Incursus
Inner Zone Shipping Catalyst
Inner Zone Shipping Imicus
Inquisitor
Intaki Syndicate Catalyst
InterBus Catalyst
InterBus Shuttle
Ishkur
Ishtar
Iteron Mark V
Ixion
Jackdaw
Jaguar
Karura
Keres
Kestrel
Khizriel
Kikimora
Kirin
Kitsune
Komodo
Kronos
Kryos
Lachesis
Laelaps
Legion
Leopard
Leshak
Leviathan
Lif
Loggerhead
Loki
Machariel
Mackinaw
Maelstrom
Magnate
Magnate Navy Issue
Magus
Malediction
Malice
Maller
Mamba
Mammoth
Marshal
Mastodon
Maulus
Maulus Navy Issue
Medusa
Megathron
Megathron Federate Issue
Megathron Navy Issue
Mekubal
Merlin
Metamorphosis
Miasmos
Miasmos Amastris Edition
Miasmos Quafe Ultra Edition
Miasmos Quafe Ultramarine Edition
Mimir
Minmatar Shuttle
Minokawa
Moa
Molok
Monitor
Moracha
Moros
Moros Navy Issue
Muninn
Myrmidon
Myrmidon Navy Issue
Naga
Naglfar
Naglfar Fleet Issue
Navitas
Nemesis
Nefantar Thrasher
Nereus
Nergal
Nestor
Nidhoggur
Nighthawk
Nightmare
Ninazu
Noctis
Nomad
Nyx
Obelisk
Occator
Omen
Omen Navy Issue
Oneiros
Onyx
Opux Luxury Yacht
Oracle
Orca
Orthrus
Osprey
Osprey Navy Issue
Pacifier
Paladin
Panther
Phantasm
Phantom
Phobos
Phoenix
Phoenix Navy Issue
Pilgrim
Pontifex
Porpoise
Praxis
Primae
Probe
Probe Fleet Issue
Procurer
Prophecy
Prophecy Navy Issue
Prorator
Prospect
Proteus
Providence
Prowler
Punisher
Purifier
Python
Quafe Catalyst
Rabisu
Ragnarok
Raiju
Rapier
Raptor
Rattlesnake
Rattlesnake Victory Edition
Raven
Raven Navy Issue
Raven State Issue
Reaper
Redeemer
Republic Fleet Firetail
Retribution
Retriever
Revelation
Revelation Navy Issue
Revenant
Rhea
Rifter
Rodiva
Rokh
Rook
Rorqual
Rupture
Sabre
Sacrilege
Sarum Magnate
Scalpel
Scimitar
Scorpion
Scorpion Ishukone Watch
Scorpion Navy Issue
Scythe
Scythe Fleet Issue
Sentinel
Shapash
Sidewinder
Sigil
Silver Magnate
Sin
Skiff
Skybreaker
Slasher
Sleipnir
Specter
Squall
Stabber
Stabber Fleet Issue
Stiletto
Stork
Stormbringer
Stratios
Stratios Emergency Responder
Succubus
Sukuuvestaa Heron
Sunesis
Svipul
Taipan
Talos
Talwar
Taranis
Tash-Murkon Magnate
Tayra
Tempest
Tempest Fleet Issue
Tempest Tribal Issue
Tengu
Thalia
Thanatos
Tholos
Thorax
Thrasher
Thrasher Fleet Issue
Thunderchild
Tiamat
Torrent
Tormentor
Tornado
Tristan
Typhoon
Typhoon Fleet Issue
Utu
Vagabond
Valravn
Vangel
Vanquisher
Vargur
Vedmak
Vehement
Velator
Vendetta
Vengeance
Venture
Vexor
Vexor Navy Issue
Vherokior Probe
Viator
Victor
Victorieux Luxury Yacht
Vigil
Vigil Fleet Issue
Vigilant
Vindicator
Violator
Virtuoso
Visitant
Vulture
Whiptail
Widow
Wolf
Worm
Wraith
Wreathe
Wyvern
Zarmazd
Zealot
Zephyr
Zirnitra`;

const SHIP_LIST = SHIPS_RAW.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

function escapeHtml(str) {
  return (str || "").replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}
function normalizeName(s){ return (s || "").trim().replace(/\s+/g, " ").toLowerCase(); }
function escapeRegExp(s){ return (s || "").replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }
function normalizeChargeName(s){ return (s || "").replace(/\s*\*+\s*$/g, "").replace(/\s+/g, " ").trim(); }

function normShip(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g," ").trim(); }
const SHIP_NORMS = SHIP_LIST.map(s => ({ name: s, norm: normShip(s) })).sort((a,b) => b.norm.length - a.norm.length);
const SHIP_ALIASES = new Map([["damntion", "Damnation"]]);

const chatInput = document.getElementById("chatInput");
const wantedInput = document.getElementById("wantedInput");
const statusText = document.getElementById("statusText");
const rosterTable = document.getElementById("rosterTable");
const applyBtn = document.getElementById("applyBtn");
const clearRosterBtn = document.getElementById("clearRosterBtn");
const summaryPills = document.getElementById("summaryPills");
const lastUpdate = document.getElementById("lastUpdate");
const wantedTable = document.getElementById("wantedTable");
const needMsg = document.getElementById("needMsg");
const filledMsg = document.getElementById("filledMsg");
const dupeMsg = document.getElementById("dupeMsg");
const profilePill = document.getElementById("profilePill");
const profileWarn = document.getElementById("profileWarn");
const profileArmorBtn = document.getElementById("profileArmorBtn");
const profileShieldBtn = document.getElementById("profileShieldBtn");
const profileMiningBtn = document.getElementById("profileMiningBtn");
const clearWantedBtn = document.getElementById("clearWantedBtn");

function nowStamp() {
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function getWantedList() { return wantedInput.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean); }

/** -----------------------------
 * Ship datalist + editing
 * ----------------------------- */
function ensureShipDatalist(){
  if (document.getElementById("shipDatalist")) return;
  const dl = document.createElement("datalist");
  dl.id = "shipDatalist";
  dl.innerHTML = SHIP_LIST.map(s => `<option value="${escapeHtml(s)}"></option>`).join("");
  document.body.appendChild(dl);
}

let state = loadState();

function setPilotShip(pilotKey, newShip){
  const r = state.roster[pilotKey];
  if (!r) return;
  r.ship = (newShip || "").trim();
  r.updatedAt = Date.now();
  saveState(state);
  renderAll(`Ship updated for ${r.pilot}`);
}

/** -----------------------------
 * Parsing
 * ----------------------------- */
function extractLinks(line) {
  const out = [];
  const re = /<url=showinfo:[^>]*>(.*?)<\/url>/gi;
  for (const m of line.matchAll(re)) {
    const rawName = (m[1] || "").trim();
    const name = normalizeChargeName(rawName);
    if (name) out.push(name);
  }
  return [...new Set(out)];
}
function parsePilot(line) {
  const m = line.match(/^\[\d{2}:\d{2}:\d{2}\]\s+(.+?)\s+>/);
  return m ? m[1].trim() : "";
}
function detectMindlink(line) { return /\b(\+ml|ml|mindlink|mind\s*link)\b/i.test(line); }
function detectShip(line) {
  const stripped = line
    .replace(/<url=showinfo:[^>]*>/gi, " ")
    .replace(/<\/url>/gi, " ")
    .replace(/^\[\d{2}:\d{2}:\d{2}\]\s+/," ")
    .replace(/\s+/g," ")
    .trim();

  const ns = normShip(stripped);
  for (const token of ns.split(" ")) {
    if (SHIP_ALIASES.has(token)) return SHIP_ALIASES.get(token);
  }
  for (const s of SHIP_NORMS) {
    if (!s.norm) continue;
    const pat = new RegExp(`(^|\\s)${escapeRegExp(s.norm)}(\\s|$)`, "i");
    if (pat.test(ns)) return s.name;
  }
  return "";
}
function parseLineToRosterUpdate(line) {
  if (!line.includes("showinfo:")) return null;
  const pilot = parsePilot(line);
  if (!pilot) return null;

  const boosts = extractLinks(line);
  if (!boosts.length) return null;

  return { pilot, boosts, ship: detectShip(line), mindlink: detectMindlink(line) };
}
function parsePastedText(text) {
  return text.split(/\r?\n/).map(l => l.trim()).filter(Boolean).map(parseLineToRosterUpdate).filter(Boolean);
}

/** -----------------------------
 * Roster ops
 * ----------------------------- */
function upsertRoster(updates) {
  let added = 0, updated = 0;
  for (const u of updates) {
    const key = normalizeName(u.pilot);
    if (!key) continue;

    const existing = state.roster[key];
    const cleanedBoosts = (u.boosts || []).map(normalizeChargeName).filter(Boolean);

    if (!existing) {
      state.roster[key] = { pilot: u.pilot, ship: u.ship || "", mindlink: !!u.mindlink, boosts: cleanedBoosts, updatedAt: Date.now() };
      added++;
    } else {
      existing.pilot = u.pilot;
      existing.ship = u.ship || existing.ship || "";
      existing.mindlink = (u.mindlink ? true : existing.mindlink);
      existing.boosts = cleanedBoosts;
      existing.updatedAt = Date.now();
      updated++;
    }
  }
  saveState(state);
  return { added, updated };
}
function removePilot(pilotKey) {
  delete state.roster[pilotKey];
  saveState(state);
  renderAll("Removed pilot");
}
function toggleMindlink(pilotKey) {
  const r = state.roster[pilotKey];
  if (!r) return;
  r.mindlink = !r.mindlink;
  r.updatedAt = Date.now();
  saveState(state);
  renderAll(`Mindlink ${r.mindlink ? "enabled" : "disabled"} for ${r.pilot}`);
}

/** -----------------------------
 * Profile selection (TOP buttons only)
 * ----------------------------- */
function setProfile(profile) {
  state.selectedProfile = profile; // "armor" | "shield" | "mining"
  if (profile === "armor") wantedInput.value = armorPvpWanted().join("\n");
  if (profile === "shield") wantedInput.value = shieldPvpWanted().join("\n");
  if (profile === "mining") wantedInput.value = miningWanted().join("\n");
  state.wantedText = wantedInput.value;
  saveState(state);
  renderAll(`Selected ${profile.toUpperCase()} profile`);
}
function renderProfileUI() {
  const p = state.selectedProfile || "";
  const setBtn = (btn, active) => {
    btn.classList.toggle("active", !!active);
    btn.setAttribute("aria-pressed", active ? "true" : "false");
  };
  setBtn(profileArmorBtn, p === "armor");
  setBtn(profileShieldBtn, p === "shield");
  setBtn(profileMiningBtn, p === "mining");

  if (!p) {
    profilePill.className = "pill warn";
    profilePill.textContent = "No profile selected";
    profileWarn.style.display = "block";
  } else {
    profilePill.className = "pill ok";
    profilePill.textContent = `Profile: ${p.toUpperCase()}`;
    profileWarn.style.display = "none";
  }
}

/** -----------------------------
 * Boost index
 * ----------------------------- */
function buildRosterBoostIndex() {
  const idx = new Map();
  for (const key of Object.keys(state.roster)) {
    const r = state.roster[key];
    for (const b of (r.boosts || [])) {
      const bn = normalizeName(normalizeChargeName(b));
      if (!bn) continue;
      if (!idx.has(bn)) idx.set(bn, []);
      idx.get(bn).push({ pilot: r.pilot || "?", ship: r.ship || "", mindlink: !!r.mindlink });
    }
  }
  return idx;
}

/** -----------------------------
 * Rendering
 * ----------------------------- */
function renderRosterTable() {
  ensureShipDatalist();
  const keys = Object.keys(state.roster).sort((a,b) => (state.roster[b].updatedAt||0) - (state.roster[a].updatedAt||0));
  if (!keys.length) {
    rosterTable.innerHTML = `<tr><td colspan="5" class="muted small">— empty roster —</td></tr>`;
    return;
  }

  rosterTable.innerHTML = keys.map(k => {
    const r = state.roster[k];
    return `
      <tr>
        <td>${escapeHtml(r.pilot || "?")}</td>
        <td><input class="shipEdit" list="shipDatalist" data-ship="${escapeHtml(k)}" value="${escapeHtml(r.ship || "")}" placeholder="Type ship…" /></td>
        <td>
          <div class="mlwrap">
            <input type="checkbox" data-ml="${escapeHtml(k)}" ${r.mindlink ? "checked" : ""}/>
            <span class="pill ${r.mindlink ? "ok" : "warn"}">${r.mindlink ? "+ML" : "—"}</span>
          </div>
        </td>
        <td class="mono small">${escapeHtml((r.boosts||[]).join(" | "))}</td>
        <td><button class="ghostbtn" data-remove="${escapeHtml(k)}">Remove</button></td>
      </tr>
    `;
  }).join("");

  rosterTable.querySelectorAll("button[data-remove]").forEach(btn => {
    btn.addEventListener("click", () => removePilot(btn.getAttribute("data-remove")));
  });
  rosterTable.querySelectorAll("input[type='checkbox'][data-ml]").forEach(cb => {
    cb.addEventListener("change", () => toggleMindlink(cb.getAttribute("data-ml")));
  });
  rosterTable.querySelectorAll("input.shipEdit[data-ship]").forEach(inp => {
    const key = inp.getAttribute("data-ship");
    inp.addEventListener("blur", () => setPilotShip(key, inp.value));
    inp.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); inp.blur(); } });
  });
}

function renderWantedComparison() {
  const wanted = getWantedList().map(normalizeChargeName);
  const idx = buildRosterBoostIndex();

  let filledCount = 0, missingCount = 0;
  const missing = [];
  const filled = [];
  const dupes = [];

  const groups = { shield: [], armor: [], skirmish: [], information: [], mining: [], other: [] };
  for (const wRaw of wanted) {
    const w = normalizeChargeName(wRaw);
    const cat = chargeCategory(w);
    (groups[cat] || groups.other).push(w);
  }
  const labelFor = { shield:"Shield", armor:"Armor", skirmish:"Skirmish", information:"Information", mining:"Mining", other:"Other" };
  const order = ["shield", "armor", "skirmish", "information", "mining", "other"];

  const rows = [];
  for (const cat of order) {
    if (!groups[cat].length) continue;
    rows.push(`<tr class="catrow"><td colspan="3">${labelFor[cat]}</td></tr>`);

    for (const w of groups[cat]) {
      const fills = idx.get(normalizeName(w)) || [];
      if (fills.length) filledCount++; else missingCount++;
      if (!fills.length) missing.push(w); else filled.push(w);

      const providers = fills.map(f => `${f.pilot}${f.ship ? ` (${f.ship})` : ""}${f.mindlink ? " +ML" : ""}`.trim());
      const isDupe = fills.length > 1;
      if (isDupe) dupes.push({ charge: w, providers });

      rows.push(`
        <tr>
          <td><span class="pill ${fills.length ? (isDupe ? "dupe" : "ok") : "bad"}">${escapeHtml(w)}</span></td>
          <td class="mono small">${escapeHtml(providers.length ? providers.join(", ") : "—")}</td>
          <td class="muted small">${escapeHtml(!fills.length ? "Not on roster yet" : (isDupe ? `DUPLICATE (${fills.length} pilots)` : `OK (${fills.length} pilot)`))}</td>
        </tr>
      `);
    }
  }

  wantedTable.innerHTML = rows.join("");

  summaryPills.innerHTML = `
    <span class="pill ok">Filled: ${filledCount}</span>
    <span class="pill bad">Missing: ${missingCount}</span>
    <span class="pill dupe">Duplicates: ${dupes.length}</span>
    <span class="pill neutral">Boosting Pilots: ${Object.keys(state.roster).length}</span>
  `;

  needMsg.textContent = missing.length
    ? `NEED CHARGES\n` + missing.map(c => `${chatTagForCharge(c)} ${c}`).join("\n")
    : `NEED CHARGES\n— all requested charges are filled —`;

  filledMsg.textContent = filled.length
    ? `FILLED CHARGES\n` + filled.map(w => {
        const providers = (idx.get(normalizeName(w)) || []).map(f => `${f.pilot}${f.ship ? ` (${f.ship})` : ""}${f.mindlink ? " +ML" : ""}`.trim());
        return `${chatTagForCharge(w)} ${w} — ${formatProviders(providers)}`;
      }).join("\n")
    : `FILLED CHARGES\n— none detected on roster yet —`;

  dupeMsg.textContent = dupes.length
    ? `DUPLICATES\n` + dupes.map(d => `${chatTagForCharge(d.charge)} ${d.charge} — ${formatProviders(d.providers)}`).join("\n")
    : `DUPLICATES\n—`;
}

function renderAll(reason="") {
  saveState(state);
  renderProfileUI();
  renderRosterTable();
  renderWantedComparison();
  lastUpdate.textContent = nowStamp();
  statusText.textContent = reason ? `✓ ${reason}` : "";
  if (reason) setTimeout(() => { statusText.textContent = ""; }, 1600);
}

/** -----------------------------
 * Blink + delayed clear for paste box
 * ----------------------------- */
function blinkAndClearPaste(delayMs = 180){
  chatInput.classList.remove("blinkClear");
  void chatInput.offsetWidth;
  chatInput.classList.add("blinkClear");
  setTimeout(() => {
    chatInput.value = "";
    setTimeout(() => chatInput.classList.remove("blinkClear"), 520);
  }, Math.max(0, delayMs));
}

/** -----------------------------
 * Events
 * ----------------------------- */
applyBtn.onclick = () => {
  const updates = parsePastedText(chatInput.value);
  if (!updates.length) { renderAll("No boost links found in paste"); return; }
  const { added, updated } = upsertRoster(updates);
  renderAll(`Applied (${added} added, ${updated} updated)`);
  blinkAndClearPaste(180);
};

clearRosterBtn.onclick = () => {
  state.roster = {};
  saveState(state);
  renderAll("Roster cleared");
};

// TOP buttons only
profileArmorBtn.onclick = () => setProfile("armor");
profileShieldBtn.onclick = () => setProfile("shield");
profileMiningBtn.onclick = () => setProfile("mining");

clearWantedBtn.onclick = () => {
  wantedInput.value = "";
  state.wantedText = "";
  state.selectedProfile = "";
  saveState(state);
  renderAll("Cleared wanted (no profile selected)");
};

let wantedTimer = null;
wantedInput.addEventListener("input", () => {
  clearTimeout(wantedTimer);
  wantedTimer = setTimeout(() => {
    state.wantedText = wantedInput.value;
    saveState(state);
    renderAll("Wanted updated");
  }, 400);
});

document.querySelectorAll("button[data-copy]").forEach(btn => {
  btn.addEventListener("click", async () => {
    const id = btn.getAttribute("data-copy");
    const el = document.getElementById(id);
    const text = el.textContent || "";
    try {
      await navigator.clipboard.writeText(text);
      statusText.textContent = "✓ Copied to clipboard";
      setTimeout(() => statusText.textContent = "", 1200);
    } catch {
      prompt("Copy this:", text);
    }
  });
});

wantedInput.value = state.wantedText || "";
renderAll("Loaded");
</script>
</body>
</html>
```
